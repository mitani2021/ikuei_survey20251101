<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ミタニ市・世論調査 集計</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#1b1f24;--muted:#6b7280;--accent:#2563eb;--danger:#dc2626}
    *{box-sizing:border-box}body{margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1080px;margin:24px auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:24px;margin-bottom:18px}
    h1{font-size:1.5rem;margin:0 0 4px} .sub{color:var(--muted);margin:0 0 20px}
    .grid{display:grid;gap:18px}
    @media(min-width:960px){.grid{grid-template-columns:1fr 1fr}}
    canvas{max-height:560px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    button{padding:10px 14px;border:none;border-radius:12px;color:#fff;background:var(--accent);font-weight:700;cursor:pointer}
    .danger{background:var(--danger)}
    a.btn{display:inline-block;text-decoration:none}
    .muted{color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ミタニ市・世論調査（集計）</h1>
      <p class="sub">票数の多い順に表示。グラフは赤色の横棒です。GAS応答形式に応じて複数の取得方式を自動で試みます。</p>
      <div class="row">
        <a class="btn" href="survey.html"><button type="button">アンケートへ</button></a>
        <button id="refresh">再読み込み</button>
        <button id="exportCsv">CSVをダウンロード</button>
        <button id="reset" class="danger">集計をリセット</button>
      </div>
      <p class="muted" id="status"></p>
    </div>

    <div class="grid">
      <div class="card">
        <h2 style="margin-top:0">ミタニ市が抱える問題（設問2）</h2>
        <canvas id="issuesChart"></canvas>
      </div>
      <div class="card">
        <h2 style="margin-top:0">候補者の支持（設問3）</h2>
        <canvas id="candsChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbycx9SQFmWzeh2RTJuSLfK-laB6_68olzggVoCMGK9ZJK6jwSKsGEgECxQvlEJtDeco1g/exec";
    const ADMIN_KEY = ""; // （必要な場合のみ）GAS側の検証と合わせる。未使用なら空のまま

    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refresh');
    const resetBtn = document.getElementById('reset');
    const exportBtn = document.getElementById('exportCsv');

    let issuesData = []; // [{label,count}]
    let candsData = [];

    function setStatus(msg){ statusEl.textContent = msg || ""; }

    // --- データ取得：複数のGAS応答方式に対応 ---
    async function fetchStats(){
      setStatus('集計取得中…');
      // 1) action=stats を試す（理想：{issues:[{label,count}], candidates:[{label,count}], total:n}）
      try{
        const r = await fetch(`${WEB_APP_URL}?action=stats`);
        if(r.ok){
          const json = await r.json();
          if(json && json.issues && json.candidates){
            return {issues: json.issues, candidates: json.candidates, total: json.total ?? null};
          }
        }
      }catch(e){}
      // 2) action=export（CSV）→ クライアントで集計（想定: district,issue,candidate,... のヘッダ）
      try{
        const r = await fetch(`${WEB_APP_URL}?action=export`);
        if(r.ok){
          const text = await r.text();
          if(text && text.includes(',')){
            return aggregateFromCSV(text);
          }
        }
      }catch(e){}
      // 3) action=list（JSON配列）→ クライアントで集計（想定: array of objects）
      try{
        const r = await fetch(`${WEB_APP_URL}?action=list`);
        if(r.ok){
          const arr = await r.json();
          if(Array.isArray(arr)){
            return aggregateFromRows(arr);
          }
        }
      }catch(e){}
      // 4) プレーンGET（JSON配列）
      try{
        const r = await fetch(WEB_APP_URL);
        if(r.ok){
          const arr = await r.json();
          if(Array.isArray(arr)){
            return aggregateFromRows(arr);
          }
        }
      }catch(e){}
      throw new Error('集計取得に失敗しました。GASの応答形式をご確認ください。');
    }

    function aggregateFromCSV(csv){
      const lines = csv.trim().split(/\r?\n/);
      const headers = lines.shift().split(',').map(s=>s.trim());
      const idxIssue = headers.findIndex(h=>/issue/i.test(h));
      const idxCand  = headers.findIndex(h=>/cand/i.test(h));
      const issues = new Map();
      const cands = new Map();
      for(const line of lines){
        const cells = parseCSVLine(line);
        const issue = (cells[idxIssue]||'').trim();
        const cand  = (cells[idxCand]||'').trim();
        if(issue){issues.set(issue, (issues.get(issue)||0)+1)}
        if(cand){cands.set(cand, (cands.get(cand)||0)+1)}
      }
      return {
        issues: [...issues.entries()].map(([label,count])=>({label,count})),
        candidates: [...cands.entries()].map(([label,count])=>({label,count})),
        total: lines.length
      };
    }

    function parseCSVLine(line){
      // 簡易CSVパーサ（ダブルクオート対応）
      const out=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(q){
          if(ch==='"'){
            if(line[i+1]==='"'){cur+='"'; i++;} else {q=false;}
          } else {cur+=ch}
        } else {
          if(ch==='"'){q=true}
          else if(ch===','){out.push(cur); cur=''}
          else {cur+=ch}
        }
      }
      out.push(cur); return out;
    }

    function aggregateFromRows(rows){
      const issues = new Map();
      const cands = new Map();
      for(const r of rows){
        const issue = (r.issue || r.Issue || r.設問2 || r["issue"] || r["設問２"])?.toString().trim();
        const cand  = (r.candidate || r.Candidate || r.候補 || r["candidate"])?.toString().trim();
        if(issue){issues.set(issue, (issues.get(issue)||0)+1)}
        if(cand){cands.set(cand, (cands.get(cand)||0)+1)}
      }
      return {
        issues: [...issues.entries()].map(([label,count])=>({label,count})),
        candidates: [...cands.entries()].map(([label,count])=>({label,count})),
        total: rows.length
      };
    }

    // --- Chart.js ヘルパ ---
    let issuesChart, candsChart;
    function toHorizontalBar(ctx, labels, counts){
      const data = {
        labels,
        datasets: [{
          label: '票数',
          data: counts,
          backgroundColor: 'rgba(220,0,0,0.8)',
          borderColor: 'rgba(220,0,0,1)',
          borderWidth: 1
        }]
      };
      const options = {
        indexAxis: 'y',
        responsive: true,
        plugins:{legend:{display:false}, tooltip:{enabled:true}},
        scales:{ x:{beginAtZero:true, ticks:{ precision:0 } } }
      };
      return new Chart(ctx, {type:'bar', data, options});
    }

    function sortDesc(arr){
      return [...arr].sort((a,b)=> b.count - a.count);
    }

    function renderCharts(){
      const sortedIssues = sortDesc(issuesData);
      const sortedCands  = sortDesc(candsData);
      const iLabels = sortedIssues.map(o=>o.label);
      const iCounts = sortedIssues.map(o=>o.count);
      const cLabels = sortedCands.map(o=>o.label);
      const cCounts = sortedCands.map(o=>o.count);
      if(issuesChart) issuesChart.destroy();
      if(candsChart) candsChart.destroy();
      issuesChart = toHorizontalBar(document.getElementById('issuesChart'), iLabels, iCounts);
      candsChart  = toHorizontalBar(document.getElementById('candsChart'),  cLabels, cCounts);
      setStatus(`集計完了：回答総数 ≈ ${iCounts.reduce((a,b)=>a+b,0)} 件`);
    }

    async function load(){
      try{
        const {issues, candidates} = await fetchStats();
        issuesData = issues; candsData = candidates; renderCharts();
      }catch(e){
        console.error(e); setStatus('集計の取得に失敗しました。GASの応答形式（action=stats/export/list）をご確認ください。');
      }
    }

    refreshBtn.addEventListener('click', load);

    // --- CSV出力（フロント生成） ---
    exportBtn.addEventListener('click', ()=>{
      const rows = [
        ['カテゴリ','項目','票数'],
        ...sortDesc(issuesData).map(o=>['問題', o.label, o.count]),
        ...sortDesc(candsData).map(o=>['候補', o.label, o.count])
      ];
      const csv = rows.map(r=> r.map(cell=>{
        const s = String(cell ?? '');
        return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'mitani_city_poll_results.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // --- リセット ---
    resetBtn.addEventListener('click', async ()=>{
      if(!confirm('集計をリセットします。よろしいですか？')) return;
      setStatus('リセット実行中…');
      try{
        // JSON POST → URL-Encoded → GET の順に試す
        const payload = {action:'reset'}; if(ADMIN_KEY) payload.adminKey = ADMIN_KEY;
        // JSON
        let r = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(!r.ok){
          // form-encoded
          const body = new URLSearchParams(payload);
          r = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body});
        }
        if(!r.ok){
          // GET fallback
          const qs = new URLSearchParams(payload).toString();
          r = await fetch(`${WEB_APP_URL}?${qs}`);
        }
        if(!r.ok) throw new Error('reset failed');
        setStatus('リセットしました。');
        await load();
      }catch(e){
        console.error(e); setStatus('リセットに失敗しました。GAS側の実装をご確認ください。');
      }
    });

    load();
  </script>
</body>
</html>
