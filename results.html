<!doctype html>
const sortedIssues = sortDesc(issuesData);
const sortedCands = sortDesc(candsData);
const iLabels = sortedIssues.map(o=>o.label);
const iCounts = sortedIssues.map(o=>o.count);
const cLabels = sortedCands.map(o=>o.label);
const cCounts = sortedCands.map(o=>o.count);
if(issuesChart) issuesChart.destroy();
if(candsChart) candsChart.destroy();
issuesChart = toHorizontalBar(document.getElementById('issuesChart'), iLabels, iCounts);
candsChart = toHorizontalBar(document.getElementById('candsChart'), cLabels, cCounts);
setStatus(`集計完了：回答総数 ≈ ${iCounts.reduce((a,b)=>a+b,0)} 件`);
}


async function load(){
try{
const {issues, candidates} = await fetchStats();
issuesData = issues; candsData = candidates; renderCharts();
}catch(e){
console.error(e); setStatus('集計の取得に失敗しました。GASの応答形式（action=stats/export/list）をご確認ください。');
}
}


refreshBtn.addEventListener('click', load);


// --- CSV出力（フロント生成） ---
exportBtn.addEventListener('click', ()=>{
const rows = [
['カテゴリ','項目','票数'],
...sortDesc(issuesData).map(o=>['問題', o.label, o.count]),
...sortDesc(candsData).map(o=>['候補', o.label, o.count])
];
const csv = rows.map(r=> r.map(cell=>{
const s = String(cell ?? '');
return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
}).join(',')).join('\n');
const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url; a.download = 'mitani_city_poll_results.csv';
document.body.appendChild(a); a.click(); a.remove();
URL.revokeObjectURL(url);
});


// --- リセット ---
resetBtn.addEventListener('click', async ()=>{
if(!confirm('集計をリセットします。よろしいですか？')) return;
setStatus('リセット実行中…');
try{
// JSON POST → URL-Encoded → GET の順に試す
const payload = {action:'reset'}; if(ADMIN_KEY) payload.adminKey = ADMIN_KEY;
// JSON
let r = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
if(!r.ok){
// form-encoded
const body = new URLSearchParams(payload);
r = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body});
}
if(!r.ok){
// GET fallback
const qs = new URLSearchParams(payload).toString();
r = await fetch(`${WEB_APP_URL}?${qs}`);
}
if(!r.ok) throw new Error('reset failed');
setStatus('リセットしました。');
await load();
}catch(e){
console.error(e); setStatus('リセットに失敗しました。GAS側の実装をご確認ください。');
}
});


load();
</script>
</body>
</html>
