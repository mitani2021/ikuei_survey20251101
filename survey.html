<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ミタニ市・世論調査</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#1b1f24;--muted:#6b7280;--accent:#2563eb;--ok:#16a34a;--err:#dc2626}
    *{box-sizing:border-box}body{margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:840px;margin:24px auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:24px}
    h1{font-size:1.5rem;margin:0 0 4px} .sub{color:var(--muted);margin:0 0 20px}
    label{display:block;font-weight:700;margin:20px 0 8px}
    select,button{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px}
    select:focus,button:focus{outline:3px solid rgba(37,99,235,.2)}
    button{background:var(--accent);color:#fff;border:none;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    .msg{margin-top:14px;padding:12px 14px;border-radius:12px;display:none}
    .ok{background:rgba(22,163,74,.08);border:1px solid rgba(22,163,74,.25);color:var(--ok)}
    .err{background:rgba(220,38,38,.08);border:1px solid rgba(220,38,38,.25);color:var(--err)}
    .foot{margin-top:18px;color:var(--muted);font-size:.9rem}
    @media(min-width:720px){.row{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ミタニ市・世論調査</h1>
      <p class="sub">以下の3問にご回答ください（所要1分）。送信と同時に集計に反映されます。</p>

      <form id="poll-form">
        <label for="district">設問1：あなたの居住している地区を教えてください</label>
        <select id="district" name="district" required>
          <option value="" disabled selected>選択してください</option>
          <option>Ｘ地区</option>
          <option>Ｙ地区</option>
          <option>Ｚ地区</option>
        </select>

        <label for="issue">設問2：あなたが最も重要だと考える問題は何ですか？</label>
        <select id="issue" name="issue" required>
          <option value="" disabled selected>選択してください</option>
          <option>Ｚ地区に多くの迷惑施設が集中していること。</option>
          <option>自分が住んでいる地区にゴミ焼却炉が建設されないこと。</option>
          <option>住民税の負担がこれ以上、増えないこと。</option>
          <option>ミタニ市のゴミの排出量を減らすこと。</option>
        </select>

        <label for="candidate">設問3：あなたは、どの候補者を支持していますか？</label>
        <select id="candidate" name="candidate" required>
          <option value="" disabled selected>選択してください</option>
          <option>神崎豪</option>
          <option>風間裕也</option>
          <option>姫島ノエル</option>
        </select>

        <div class="row">
          <button id="submitBtn" type="submit">送信する</button>
          <a href="results.html" style="text-decoration:none"><button type="button" style="background:#111827">集計を見る</button></a>
        </div>
        <div id="ok" class="msg ok">ご協力ありがとうございます。回答を記録しました。</div>
        <div id="er" class="msg err">送信に失敗しました。しばらくしてから再度お試しください。</div>
        <p class="foot">※個人情報は取得しません。必要に応じてIP重複などの制御はGAS側で行ってください。</p>
      </form>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbycx9SQFmWzeh2RTJuSLfK-laB6_68olzggVoCMGK9ZJK6jwSKsGEgECxQvlEJtDeco1g/exec";

    const form = document.getElementById('poll-form');
    const ok = document.getElementById('ok');
    const er = document.getElementById('er');
    const btn = document.getElementById('submitBtn');

    function showMsg(el){el.style.display='block'; setTimeout(()=>el.style.display='none', 4000)}

    async function trySubmit(payload){
      // 1) JSON POST（推奨）
      try{
        const r = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'submit', ...payload})});
        if(r.ok){return await r.json().catch(()=>({ok:true}))}
      }catch(e){}
      // 2) フォームURLエンコードPOST
      try{
        const body = new URLSearchParams({action:'submit', ...payload});
        const r = await fetch(WEB_APP_URL, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body});
        if(r.ok){return await r.json().catch(()=>({ok:true}))}
      }catch(e){}
      // 3) GET クエリ
      const qs = new URLSearchParams({action:'submit', ...payload}).toString();
      const r = await fetch(`${WEB_APP_URL}?${qs}`);
      if(r.ok){try{return await r.json()}catch(e){return {ok:true}}}
      throw new Error('submit failed');
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      ok.style.display=er.style.display='none';
      btn.disabled=true; btn.textContent='送信中…';
      const payload = {
        district: document.getElementById('district').value,
        issue: document.getElementById('issue').value,
        candidate: document.getElementById('candidate').value,
        ts: new Date().toISOString()
      };
      try{
        await trySubmit(payload);
        showMsg(ok); form.reset();
      }catch(err){
        console.error(err); showMsg(er);
      }finally{ btn.disabled=false; btn.textContent='送信する'; }
    });
  </script>
</body>
</html>
